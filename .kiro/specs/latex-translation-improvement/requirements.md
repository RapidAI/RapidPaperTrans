# LaTeX 翻译改进需求文档

## 概述
改进 LaTeX 翻译流程，解决 LLM 翻译后添加额外内容导致编译失败的问题，并设计一个基于编译错误的智能修复流程。同时添加源文件预处理功能，在编译和翻译之前修复常见的 LaTeX 源文件问题。

## 问题分析

### 当前问题
1. **LLM 添加额外内容**：翻译时 LLM 可能添加解释、注释或修改 LaTeX 命令
2. **上下文限制**：大型文档需要分块翻译，但分块可能破坏 LaTeX 结构
3. **编译失败**：翻译后的文档可能因语法错误无法编译
4. **修复效率低**：当前的语法验证只检测基本错误，无法处理编译器报告的实际错误
5. **源文件问题**：原始 LaTeX 源文件可能存在问题（如 bibliography 顺序错误），导致即使原文也无法正确编译

### 解决方案概述
1. **源文件预处理**：解压后立即对所有 tex 文件应用 QuickFix，修复常见问题
2. **改进翻译提示词**：更严格的指令，禁止添加任何额外内容
3. **智能分块策略**：按 LaTeX 结构分块，保持环境完整性
4. **编译驱动的修复循环**：使用实际编译错误来指导修复
5. **增量修复**：只修复出错的部分，减少上下文消耗

---

## 用户故事

### 0. 源文件预处理

#### 0.1 解压后自动预处理
**作为** 用户
**我希望** 系统在解压 LaTeX 源文件后自动修复常见问题
**以便** 原始文档和翻译后的文档都能正确编译

**验收标准：**
- AC0.1.1: 解压完成后，自动扫描所有 .tex 文件
- AC0.1.2: 对每个 .tex 文件应用 QuickFix 规则修复常见问题
- AC0.1.3: 修复后的内容直接覆盖原文件
- AC0.1.4: 记录预处理修复的文件和修复内容
- AC0.1.5: 预处理在原文编译和翻译之前完成

#### 0.2 Bibliography 顺序修复
**作为** 用户
**我希望** 系统自动修复 \bibliography 和 \bibliographystyle 的顺序问题
**以便** 参考文献引用能正确显示

**验收标准：**
- AC0.2.1: 检测 \bibliography{...} 在 \bibliographystyle{...} 之前的情况
- AC0.2.2: 自动交换两者顺序，使 \bibliographystyle 在前
- AC0.2.3: 保持其他内容不变
- AC0.2.4: 修复后 bibtex 能正确生成 .bbl 文件

### 1. 翻译质量改进

#### 1.1 严格的翻译输出
**作为** 用户
**我希望** LLM 翻译时只输出翻译后的 LaTeX 内容，不添加任何额外内容
**以便** 翻译结果可以直接编译

**验收标准：**
- AC1.1.1: 翻译输出不包含任何解释性文字（如 "Here is the translation:"）
- AC1.1.2: 翻译输出不包含 markdown 代码块标记（如 ```latex）
- AC1.1.3: 所有 LaTeX 命令保持原样，不被修改或删除
- AC1.1.4: 数学公式内容完全保留，不被翻译
- AC1.1.5: 注释（%开头的行）保持原样或翻译注释内容但保留%前缀

#### 1.2 智能分块翻译
**作为** 用户
**我希望** 大型文档能够智能分块翻译，保持 LaTeX 结构完整性
**以便** 分块翻译不会破坏文档结构

**验收标准：**
- AC1.2.1: 分块时不会在 \begin{} 和 \end{} 之间切断
- AC1.2.2: 分块时不会在数学环境（$...$, $$...$$, \[...\]）中间切断
- AC1.2.3: 分块优先在章节边界（\section, \subsection 等）处切分
- AC1.2.4: 每个分块包含足够的上下文信息（如文档类型、使用的包）

---

### 2. 编译驱动的修复流程

#### 2.1 编译错误解析
**作为** 系统
**我希望** 能够解析 LaTeX 编译器的错误输出
**以便** 准确定位和理解编译错误

**验收标准：**
- AC2.1.1: 能够从编译日志中提取错误行号
- AC2.1.2: 能够提取错误类型和错误消息
- AC2.1.3: 能够识别常见的 LaTeX 错误模式（未定义命令、缺少包、括号不匹配等）
- AC2.1.4: 能够提取错误上下文（错误前后的几行代码）

#### 2.2 智能错误修复
**作为** 用户
**我希望** 系统能够根据编译错误自动修复 LaTeX 语法问题
**以便** 翻译后的文档能够成功编译

**验收标准：**
- AC2.2.1: 修复时只发送错误相关的代码片段给 LLM，而非整个文档
- AC2.2.2: 修复提示包含具体的错误信息和上下文
- AC2.2.3: 修复后的代码能够正确替换原文档中的对应部分
- AC2.2.4: 支持多轮修复，直到编译成功或达到最大尝试次数

#### 2.3 修复循环控制
**作为** 用户
**我希望** 修复流程有合理的终止条件
**以便** 避免无限循环或过度消耗资源

**验收标准：**
- AC2.3.1: 设置最大修复尝试次数（默认 5 次）
- AC2.3.2: 如果连续修复未能减少错误数量，提前终止
- AC2.3.3: 记录每次修复的详细日志，便于调试
- AC2.3.4: 修复失败时提供有意义的错误信息给用户

---

### 3. 上下文优化

#### 3.1 最小化上下文使用
**作为** 系统
**我希望** 在修复错误时使用最小必要的上下文
**以便** 支持上下文窗口较小的 LLM

**验收标准：**
- AC3.1.1: 修复单个错误时，只发送错误行及其前后 N 行（可配置，默认 10 行）
- AC3.1.2: 如果多个错误在相邻区域，合并为一个修复请求
- AC3.1.3: 提供文档的结构摘要（使用的包、文档类型）作为上下文
- AC3.1.4: 修复请求的 token 数量不超过配置的上下文窗口的 50%

#### 3.2 错误优先级排序
**作为** 系统
**我希望** 按优先级处理编译错误
**以便** 先修复影响最大的错误

**验收标准：**
- AC3.2.1: 致命错误（如缺少 \end{document}）优先处理
- AC3.2.2: 早期错误（行号较小）优先处理，因为可能导致后续错误
- AC3.2.3: 相同类型的错误批量处理
- AC3.2.4: 跳过警告，只处理错误

---

## 技术约束

1. **LLM 兼容性**：支持 OpenAI API 兼容的服务（包括 DeepSeek）
2. **上下文限制**：默认假设 8K token 上下文窗口，可配置
3. **编译器支持**：支持 pdflatex 和 xelatex
4. **性能要求**：单次修复请求应在 60 秒内完成
5. **错误处理**：所有 API 调用需要有重试机制和超时处理

---

## 非功能需求

1. **可观测性**：详细的日志记录，包括每次 LLM 调用的输入输出
2. **可配置性**：关键参数（最大重试次数、上下文行数等）可通过配置调整
3. **向后兼容**：新流程应该兼容现有的配置文件格式
