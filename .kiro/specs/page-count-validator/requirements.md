# 页数验证与自动修复功能需求

## 1. 概述

在 LaTeX 翻译过程中，经常会出现翻译后的 PDF 页数少于原始 PDF 的情况。这通常是由于：
- LaTeX 语法错误（如多余的大括号）
- 被注释掉的内容引用
- 缺失的文件引用
- 文档类选项隐藏了部分内容

本功能旨在自动检测和修复这些问题，确保翻译后的文档完整性。

## 2. 用户故事

### 2.1 作为用户，我希望系统能自动检测页数缺失问题
**验收标准：**
- 系统能够比较原始 PDF 和翻译后 PDF 的页数
- 当页数不匹配时，系统能够给出明确的警告
- 系统能够估算缺失的页数

### 2.2 作为用户，我希望系统能诊断页数缺失的原因
**验收标准：**
- 系统能够检测未引用的 .tex 文件
- 系统能够检测被注释掉的 \input 命令
- 系统能够检测 LaTeX 语法错误（大括号不平衡、环境不匹配等）
- 系统能够检测文档类选项中的隐藏选项（如 hidesupplement）
- 系统能够检测条件编译块（\iffalse）
- 系统能够生成详细的诊断报告

### 2.3 作为用户，我希望系统能自动修复常见的页数缺失问题
**验收标准：**
- 系统能够自动取消注释存在的 \input 文件
- 系统能够自动移除隐藏内容的文档类选项
- 系统能够自动修复简单的语法错误（如多余的大括号）
- 系统能够自动将 \iffalse 改为 \iftrue
- 系统能够自动添加缺失的附录文件引用
- 所有修复操作都会创建备份文件

### 2.4 作为用户，我希望在编译完成后自动运行页数验证
**验收标准：**
- 编译成功后，系统自动比较页数
- 如果页数不匹配，自动运行诊断
- 系统提供修复建议或自动修复选项
- 修复后自动重新编译验证

### 2.5 作为用户，我希望能够手动运行诊断和修复工具
**验收标准：**
- 提供独立的诊断命令
- 提供独立的修复命令
- 支持指定原始 PDF 路径进行比较
- 支持批量处理多个文档

## 3. 功能需求

### 3.1 页数比较功能
- 读取原始 PDF 的页数
- 读取翻译后 PDF 的页数
- 计算页数差异
- 生成比较报告

### 3.2 诊断功能

#### 3.2.1 文件引用检查
- 扫描主 .tex 文件中的所有 \input 和 \include 命令
- 检查引用的文件是否存在
- 检查是否有未引用的 .tex 文件
- 检查是否有被注释的引用

#### 3.2.2 语法检查
- 检查大括号平衡（{ 和 }）
- 检查环境平衡（\begin{} 和 \end{}）
- 检查常见的语法错误模式
- 逐行追踪平衡状态，定位错误位置

#### 3.2.3 内容隐藏检查
- 检查文档类选项（hidesupplement, hideappendix 等）
- 检查条件编译（\iffalse, \iftrue）
- 检查注释块（\begin{comment}）
- 检查大型连续注释区域

#### 3.2.4 附录检查
- 检查 \appendix 命令的位置
- 检查附录是否在 \end{document} 之前
- 检查附录区域的内容量
- 检查附录文件的引用

### 3.3 自动修复功能

#### 3.3.1 文件引用修复
- 取消注释存在的 \input 文件
- 添加缺失的附录文件引用
- 保持原始缩进格式

#### 3.3.2 语法修复
- 移除多余的闭合大括号
- 修复简单的环境不匹配
- 修复常见的语法错误模式

#### 3.3.3 内容显示修复
- 移除隐藏内容的文档类选项
- 将 \iffalse 改为 \iftrue
- 取消注释 \begin{comment} 块（可选）

#### 3.3.4 附录修复
- 将附录移到 \end{document} 之前
- 添加缺失的 \appendix 命令
- 添加附录文件引用

### 3.4 备份和恢复功能
- 所有修复操作前自动创建备份
- 备份文件命名规则：原文件名 + .backup + 时间戳
- 提供恢复命令从备份恢复
- 自动清理旧备份（可配置）

### 3.5 报告功能
- 生成详细的诊断报告
- 列出所有发现的问题
- 提供修复建议
- 记录修复操作历史
- 支持 JSON 和文本格式输出

## 4. 非功能需求

### 4.1 性能
- 诊断操作应在 5 秒内完成（对于 100KB 的 .tex 文件）
- 修复操作应在 2 秒内完成
- 支持处理大型文档（>1MB）

### 4.2 可靠性
- 所有修复操作必须可逆（通过备份）
- 修复失败时不应损坏原文件
- 提供详细的错误信息

### 4.3 可用性
- 提供清晰的命令行界面
- 提供详细的帮助信息
- 支持交互式和非交互式模式
- 集成到主工具的编译流程中

### 4.4 可扩展性
- 支持添加新的诊断规则
- 支持添加新的修复策略
- 支持自定义配置

## 5. 技术约束

- 使用 Go 语言实现
- 集成到现有的 latex-translator 项目
- 复用现有的 PDF 解析器（internal/pdf/parser.go）
- 复用现有的编译器（internal/compiler/compiler.go）
- 使用现有的验证器框架（internal/validator/）

## 6. 集成点

### 6.1 编译流程集成
- 在 `internal/compiler/compiler.go` 的 `Compile` 方法中集成
- 编译成功后自动运行页数验证
- 如果页数不匹配，运行诊断并提供修复选项

### 6.2 前端集成
- 在前端显示页数比较结果
- 提供"自动修复"按钮
- 显示诊断报告
- 显示修复历史

### 6.3 命令行工具
- 提供独立的诊断命令
- 提供独立的修复命令
- 支持批量处理

## 7. 测试需求

### 7.1 单元测试
- 测试各个诊断规则
- 测试各个修复策略
- 测试备份和恢复功能

### 7.2 集成测试
- 测试完整的诊断-修复流程
- 测试与编译器的集成
- 测试与前端的集成

### 7.3 端到端测试
- 使用真实的 arXiv 论文测试
- 测试各种页数缺失场景
- 验证修复后的文档完整性

## 8. 文档需求

- API 文档
- 用户指南
- 故障排除指南
- 最佳实践文档

## 9. 优先级

### P0 (必须有)
- 页数比较功能
- 基本诊断功能（文件引用、语法检查）
- 基本修复功能（取消注释、移除隐藏选项）
- 备份功能

### P1 (应该有)
- 附录检查和修复
- 详细的诊断报告
- 编译流程集成
- 前端集成

### P2 (可以有)
- 批量处理
- 自定义配置
- 修复历史记录
- 高级语法修复

## 10. 成功指标

- 能够自动检测 90% 以上的页数缺失问题
- 能够自动修复 70% 以上的常见问题
- 修复后的文档页数匹配率达到 95% 以上
- 用户满意度评分 > 4.5/5
